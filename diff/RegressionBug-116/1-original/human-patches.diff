Only in ./RegMiner4APR-Regression-Bugs/BUGGY: generated-dependencies
diff -r -U 3 ./RegMiner4APR-Regression-Bugs/BUGGY/src/main/java/com/bmwcarit/barefoot/markov/KState.java ./RegMiner4APR-Regression-Bugs/BFC/src/main/java/com/bmwcarit/barefoot/markov/KState.java
--- ./RegMiner4APR-Regression-Bugs/BUGGY/src/main/java/com/bmwcarit/barefoot/markov/KState.java	2025-12-19 04:16:18.000000000 +1100
+++ ./RegMiner4APR-Regression-Bugs/BFC/src/main/java/com/bmwcarit/barefoot/markov/KState.java	2025-12-19 04:16:13.000000000 +1100
@@ -27,7 +27,7 @@
 import org.json.JSONException;
 import org.json.JSONObject;
 
-import com.bmwcarit.barefoot.util.Triple;
+import com.bmwcarit.barefoot.util.Tuple;
 
 /**
  * <i>k</i>-State data structure for organizing state memory in HMM inference.
@@ -40,7 +40,7 @@
         extends StateMemory<C, T, S> {
     private final int k;
     private final long t;
-    private final LinkedList<Triple<Set<C>, S, C>> sequence;
+    private final LinkedList<Tuple<Set<C>, S>> sequence;
     private final Map<C, Integer> counters;
 
     /**
@@ -100,15 +100,13 @@
             }
 
             S sample = factory.sample(jsonseqelement.getJSONObject("sample"));
-            String kestid = jsonseqelement.getString("kestid");
-            C kestimate = candidates.get(kestid);
 
-            sequence.add(new Triple<>(vector, sample, kestimate));
+            sequence.add(new Tuple<>(vector, sample));
         }
 
-        Collections.sort(sequence, new Comparator<Triple<Set<C>, S, C>>() {
+        Collections.sort(sequence, new Comparator<Tuple<Set<C>, S>>() {
             @Override
-            public int compare(Triple<Set<C>, S, C> left, Triple<Set<C>, S, C> right) {
+            public int compare(Tuple<Set<C>, S> left, Tuple<Set<C>, S> right) {
                 if (left.two().time() < right.two().time()) {
                     return -1;
                 } else if (left.two().time() > right.two().time()) {
@@ -169,7 +167,7 @@
      */
     public List<S> samples() {
         LinkedList<S> samples = new LinkedList<>();
-        for (Triple<Set<C>, S, C> element : sequence) {
+        for (Tuple<Set<C>, S> element : sequence) {
             samples.add(element.two());
         }
         return samples;
@@ -185,23 +183,23 @@
             throw new RuntimeException("out-of-order state update is prohibited");
         }
 
-        C kestimate = null;
+        C estimate = estimate();
         for (C candidate : vector) {
             counters.put(candidate, 0);
+            if (candidate.predecessor() == null) {
+                candidate.predecessor(estimate);
+            }
             if (candidate.predecessor() != null) {
                 if (!counters.containsKey(candidate.predecessor())
                         || !sequence.peekLast().one().contains(candidate.predecessor())) {
                     throw new RuntimeException("inconsistent update vector");
                 }
                 counters.put(candidate.predecessor(), counters.get(candidate.predecessor()) + 1);
             }
-            if (kestimate == null || candidate.seqprob() > kestimate.seqprob()) {
-                kestimate = candidate;
-            }
         }
 
         if (!sequence.isEmpty()) {
-            Triple<Set<C>, S, C> last = sequence.peekLast();
+            Tuple<Set<C>, S> last = sequence.peekLast();
             Set<C> deletes = new HashSet<>();
 
             for (C candidate : last.one()) {
@@ -210,16 +208,12 @@
                 }
             }
 
-            int size = sequence.peekLast().one().size();
-
             for (C candidate : deletes) {
-                if (deletes.size() != size || candidate != last.three()) {
-                    remove(candidate, sequence.size() - 1);
-                }
+                remove(candidate, sequence.size() - 1);
             }
         }
 
-        sequence.add(new Triple<>(vector, sample, kestimate));
+        sequence.add(new Tuple<>(vector, sample));
 
         while ((t > 0 && sample.time() - sequence.peekFirst().two().time() > t)
                 || (k >= 0 && sequence.size() > k + 1)) {
@@ -237,19 +231,23 @@
     }
 
     protected void remove(C candidate, int index) {
-        if (sequence.get(index).three() == candidate) {
-            return;
-        }

-        Set<C> vector = sequence.get(index).one();
-        counters.remove(candidate);
-        vector.remove(candidate);
+        while (index >= 0) {
+            Set<C> vector = sequence.get(index).one();
+            counters.remove(candidate);
+            vector.remove(candidate);
+
+            C predecessor = candidate.predecessor();
+            if (predecessor == null) {
+                return;
+            }
 
-        C predecessor = candidate.predecessor();
-        if (predecessor != null) {
             counters.put(predecessor, counters.get(predecessor) - 1);
+
             if (counters.get(predecessor) == 0) {
-                remove(predecessor, index - 1);
+                candidate = predecessor;
+                index -= 1;
+            } else {
+                return;
             }
         }
     }
@@ -289,16 +287,13 @@
             return null;
         }
 
-        C kestimate = sequence.peekLast().three();
+        C kestimate = estimate();
         LinkedList<C> ksequence = new LinkedList<>();
 
         for (int i = sequence.size() - 1; i >= 0; --i) {
             if (kestimate != null) {
                 ksequence.push(kestimate);
                 kestimate = kestimate.predecessor();
-            } else {
-                ksequence.push(sequence.get(i).three());
-                kestimate = sequence.get(i).three().predecessor();
             }
         }
 
@@ -309,7 +304,7 @@
     public JSONObject toJSON() throws JSONException {
         JSONObject json = new JSONObject();
         JSONArray jsonsequence = new JSONArray();
-        for (Triple<Set<C>, S, C> element : sequence) {
+        for (Tuple<Set<C>, S> element : sequence) {
             JSONObject jsonseqelement = new JSONObject();
             JSONArray jsonvector = new JSONArray();
             for (C candidate : element.one()) {
@@ -321,7 +316,6 @@
             }
             jsonseqelement.put("vector", jsonvector);
             jsonseqelement.put("sample", element.two().toJSON());
-            jsonseqelement.put("kestid", element.three().id());
             jsonsequence.put(jsonseqelement);
         }
 
